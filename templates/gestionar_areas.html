{% extends "base.html" %}

{% block title %}Gestión de Campañas | Bridges{% endblock %}

{% block content %}

  <!-- SECCIÓN 1: ÁREAS -->
  <div class="section" id="seccion-areas">
    <h2>Gestión de Campañas</h2>

    <form action="{{ url_for('agregar_area') }}" method="post">
      <input type="text" name="nombre_area" placeholder="YYYY-MM-DD | Distrito/Zona | Responsable | Nombre" required>
      <button type="submit">Agregar Área</button>
    </form>

    <table id="tabla-areas" class="display">
      <thead>
        <tr>
          <th>Campaña</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for area in areas %}
        <tr data-area-id="{{ area.id }}">
          <td>{{ area.nombre }}</td>
          <td>
            <button class="btn-ver-materiales" type="button">Actividades</button>

            <form action="{{ url_for('eliminar_area', area_id=area.id) }}" method="post" style="display:inline;">
              <button type="submit" onclick="return confirm('¿Estás seguro de eliminar esta área?');">Eliminar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- SECCIÓN 2: MATERIALES -->
  <div class="section hidden" id="seccion-materiales">
    <h2>Actividades de <span id="nombre-area-seleccionada"></span></h2>
    <button type="button" onclick="volverAreas()">Volver a Áreas</button>

    <form id="form-agregar-material">
      <input type="text" id="nombre_material" placeholder="Nombre del Material" required>
      <input type="hidden" id="area_id">
      <button type="submit">Agregar Actividad</button>
    </form>

    <div id="lista-materiales"></div>
  </div>

  <!-- SECCIÓN 3: ASIGNACIÓN DE ÍTEMS -->
  <div class="section hidden" id="seccion-asignacion">
    <h2>Asignar Ítems a <span id="nombre-material-seleccionado"></span></h2>
    <button type="button" onclick="volverMateriales()">Volver a Materiales</button>

    <div id="form-asignar-items"></div>
  </div>

{% endblock %}

{% block extra_head %}
<style>
  /* Solo estilos que NO estén ya en base.html */
  .section { margin-bottom: 30px; }
  input, select { padding: 5px; margin-top: 5px; }
  .hidden { display: none; }
</style>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function() {

    /* ===============================
       TABLA PRINCIPAL (CAMPAÑAS)
       =============================== */
    $('#tabla-areas').DataTable();


    /* ===============================
       VER ACTIVIDADES DE UNA CAMPAÑA
       =============================== */
    $('.btn-ver-materiales').on('click', function() {
      const areaId = $(this).closest('tr').data('area-id');
      const areaNombre = $(this).closest('tr').find('td:first').text();

      $('#nombre-area-seleccionada').text(areaNombre);
      $('#area_id').val(areaId);

      $('#seccion-areas').addClass('hidden');
      $('#seccion-materiales').removeClass('hidden');

      cargarMateriales(areaId);
    });


    /* ===============================
       CARGAR ACTIVIDADES (MATERIALES)
       =============================== */
    function cargarMateriales(areaId) {
      $.get('/areas/' + areaId + '/materiales', function(data) {
        $('#lista-materiales').html(data);
      });
    }


    /* ===============================
       AGREGAR ACTIVIDAD
       =============================== */
    $(document).on('submit', '#form-agregar-material', function(e) {
      e.preventDefault();

      const nombreMaterial = $('#nombre_material').val().trim();
      const areaId = $('#area_id').val();

      if (!nombreMaterial) {
        alert("El nombre del material no puede estar vacío");
        return;
      }
      if (!areaId) {
        alert("Error: No se pudo identificar el área seleccionada.");
        return;
      }

      $.post(`/materiales/agregar/${areaId}`, { nombre_material: nombreMaterial })
        .done(function() {
          $('#nombre_material').val('');
          cargarMateriales(areaId);
        })
        .fail(function(xhr, status, error) {
          alert("Error al agregar el material: " + error);
          console.error(xhr.responseText);
        });
    });


    /* ===============================
       ABRIR ASIGNACIÓN DE ÍTEMS
       =============================== */
    $(document).on('click', '.btn-asignar-items', function (e) {
      e.preventDefault();
      e.stopPropagation();

      const materialId = $(this).data('material-id');
      const materialNombre = $(this).data('material-nombre');

      $('#nombre-material-seleccionado').text(materialNombre);
      $('#seccion-materiales').addClass('hidden');
      $('#seccion-asignacion').removeClass('hidden');

      $.get('/asignar_items/' + materialId, function(html) {
        $('#form-asignar-items').html(html);
      });
    });


    /* ===============================
       ASIGNAR ÍTEM (AJAX)
       =============================== */
    $(document).on('submit', 'form.js-asignar-item', function (e) {
      e.preventDefault();

      const $form = $(this);
      const materialId = $form.find('input[name="material_id"]').val();

      $.post($form.attr('action'), $form.serialize())
        .done(function () {
          $.get('/asignar_items/' + materialId, function (html) {
            $('#form-asignar-items').html(html);
          });
        })
        .fail(function (xhr) {
          alert('Error al asignar: ' + (xhr.responseText || xhr.statusText));
        });
    });


    /* ===============================
       ELIMINAR ASIGNACIÓN (AJAX)
       =============================== */
    $(document).on('submit', 'form.js-eliminar-asignacion', function (e) {
      e.preventDefault();

      const $form = $(this);
      const materialId = $form.find('input[name="material_id"]').val();

      $.post($form.attr('action'), $form.serialize())
        .done(function () {
          $.get('/asignar_items/' + materialId, function (html) {
            $('#form-asignar-items').html(html);
          });
        })
        .fail(function (xhr) {
          alert('Error al eliminar: ' + (xhr.responseText || xhr.statusText));
        });
    });

  });


  /* ===============================
     NAVEGACIÓN ENTRE SECCIONES
     =============================== */
  function volverAreas() {
    $('#seccion-materiales').addClass('hidden');
    $('#seccion-areas').removeClass('hidden');
  }

  function volverMateriales() {
    $('#seccion-asignacion').addClass('hidden');
    $('#seccion-materiales').removeClass('hidden');
  }
</script>

{% endblock %}
